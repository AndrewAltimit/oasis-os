---
name: CI

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  ci:
    name: OASIS_OS CI
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      - name: Pre-checkout cleanup
        run: |
          # Remove root-owned files left by Docker containers from previous runs.
          # Without this, actions/checkout fails with EACCES on self-hosted runners.
          for item in outputs target psp_output_file.log .git/index.lock; do
            if [ -d "$item" ] || [ -f "$item" ]; then
              docker run --rm -v "$(pwd):/workspace" busybox:1.36.1 sh -c \
                "rm -rf /workspace/$item" 2>/dev/null || \
                sudo rm -rf "$item" 2>/dev/null || true
            fi
          done

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set UID/GID
        run: |
          echo "USER_ID=$(id -u)" >> $GITHUB_ENV
          echo "GROUP_ID=$(id -g)" >> $GITHUB_ENV

      # -- Formatting -------------------------------------------------------
      - name: Format check
        run: docker compose --profile ci run --rm rust-ci cargo fmt --all -- --check

      # -- Linting -----------------------------------------------------------
      - name: Clippy
        run: docker compose --profile ci run --rm rust-ci cargo clippy --workspace -- -D warnings

      # -- Tests -------------------------------------------------------------
      - name: Test
        run: docker compose --profile ci run --rm rust-ci cargo test --workspace

      # -- Build -------------------------------------------------------------
      - name: Build (release)
        run: docker compose --profile ci run --rm rust-ci cargo build --workspace --release

      # -- License / Advisory ------------------------------------------------
      - name: cargo-deny
        run: docker compose --profile ci run --rm rust-ci cargo deny check

      # -- PSP Backend Build -------------------------------------------------
      - name: Build PSP EBOOT
        run: |
          cd crates/oasis-backend-psp
          RUST_PSP_BUILD_STD=1 cargo +nightly psp --release

      # -- PSP Emulator Test -------------------------------------------------
      - name: Run OASIS_OS EBOOT in PPSSPPHeadless
        run: |
          docker compose --profile psp run --rm -e PPSSPP_HEADLESS=1 ppsspp \
            /roms/release/EBOOT.PBP --timeout=5 2>/dev/null || true

          if [ -f psp_output_file.log ]; then
            cat psp_output_file.log
          else
            echo "No output log -- headless exited without crash (TIMEOUT ok)"
          fi

      # -- Cleanup -----------------------------------------------------------
      - name: Fix Docker file ownership
        if: always()
        run: |
          # Fix root-owned files so the next run's checkout can clean them
          for dir in target outputs; do
            if [ -d "$dir" ]; then
              docker run --rm -v "$(pwd)/$dir:/workspace" busybox:1.36.1 \
                chown -Rh "$(id -u):$(id -g)" /workspace 2>/dev/null || true
            fi
          done
